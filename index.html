<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PBD Editor Mode</title>
    <style>
      body {
        margin: 0;
        background: #222;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
      }
      canvas {
        background: #333;
        box-shadow: 0 0 20px black;
        cursor: crosshair;
      }
      .controls {
        margin-bottom: 10px;
        padding: 10px;
        background: #444;
        border-radius: 8px;
      }
      button {
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
      }
      .active {
        background: cyan;
        font-weight: bold;
      }
      .hints {
        font-size: 0.9em;
        color: #ccc;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button id="btnEdit" class="active">âœï¸ EDIT</button>
      <button id="btnSim">â–¶ï¸ SIMULATE</button>
      <button
        id="btnClear"
        style="margin-left: 20px; background: #ff4444; color: white"
      >
        ğŸ—‘ï¸ CLEAR
      </button>
    </div>

    <canvas id="simCanvas" width="800" height="600"></canvas>

    <div class="hints">
      [å·¦ã‚¯ãƒªãƒƒã‚¯]: ç‚¹ã‚’è¿½åŠ  / ç‚¹ã‚’é¸æŠã—ã¦æ¥ç¶š<br />
      [å³ã‚¯ãƒªãƒƒã‚¯]: å›ºå®š/è§£é™¤åˆ‡ã‚Šæ›¿ãˆ<br />
      [SIMãƒ¢ãƒ¼ãƒ‰]: ãƒã‚¦ã‚¹ã§ãƒ‰ãƒ©ãƒƒã‚°
    </div>

    <script src="index.js"></script>

    <script>
      Module.onRuntimeInitialized = function () {
        const canvas = document.getElementById("simCanvas");
        const ctx = canvas.getContext("2d");
        const world = new Module.World();

        // çŠ¶æ…‹ç®¡ç†
        let mode = "edit"; // 'edit' or 'sim'
        let selectedIndex = -1; // æ¥ç¶šå…ƒã¨ã—ã¦é¸æŠã•ã‚ŒãŸç‚¹
        let isDragging = false;
        let draggedPointIndex = -1;

        // ãƒœã‚¿ãƒ³è¨­å®š
        const btnEdit = document.getElementById("btnEdit");
        const btnSim = document.getElementById("btnSim");
        const btnClear = document.getElementById("btnClear");

        btnEdit.onclick = () => {
          mode = "edit";
          updateButtons();
        };
        btnSim.onclick = () => {
          mode = "sim";
          selectedIndex = -1;
          updateButtons();
        };
        btnClear.onclick = () => {
          world.clear();
          selectedIndex = -1;
        };

        function updateButtons() {
          btnEdit.className = mode === "edit" ? "active" : "";
          btnSim.className = mode === "sim" ? "active" : "";
          // ã‚·ãƒ ãƒ¢ãƒ¼ãƒ‰ãªã‚‰çŸ¢å°ã€ç·¨é›†ãªã‚‰åå­—ã‚«ãƒ¼ã‚½ãƒ«
          canvas.style.cursor = mode === "sim" ? "default" : "crosshair";
        }

        function getMousePos(evt) {
          const rect = canvas.getBoundingClientRect();
          return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }

        function findNearestParticle(x, y, radius = 20) {
          let minD = radius;
          let target = -1;
          const count = world.getParticleCount();
          for (let i = 0; i < count; i++) {
            const px = world.getParticleX(i);
            const py = world.getParticleY(i);
            const d = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
            if (d < minD) {
              minD = d;
              target = i;
            }
          }
          return target;
        }

        // --- ãƒã‚¦ã‚¹æ“ä½œ ---

        canvas.addEventListener("mousedown", (e) => {
          const pos = getMousePos(e);
          const target = findNearestParticle(pos.x, pos.y);

          if (mode === "edit") {
            // å³ã‚¯ãƒªãƒƒã‚¯ (button 2) ã¯å›ºå®šåˆ‡ã‚Šæ›¿ãˆ
            if (e.button === 2) {
              if (target !== -1) world.toggleFixed(target);
              return;
            }

            // å·¦ã‚¯ãƒªãƒƒã‚¯
            if (target === -1) {
              // ä½•ã‚‚ãªã„ã¨ã“ã‚ -> ç‚¹ã‚’è¿½åŠ 
              world.addParticle(pos.x, pos.y, false); // å›ºå®šãªã—ã§è¿½åŠ 
              selectedIndex = -1; // é¸æŠè§£é™¤
            } else {
              // ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
              if (selectedIndex === -1) {
                // 1ã¤ç›®ã®é¸æŠ
                selectedIndex = target;
              } else {
                // 2ã¤ç›®ã®é¸æŠ -> æ¥ç¶šï¼
                if (selectedIndex !== target) {
                  world.addConstraint(selectedIndex, target);
                  selectedIndex = -1; // æ¥ç¶šå®Œäº†ã—ãŸã‚‰é¸æŠè§£é™¤
                } else {
                  selectedIndex = -1; // è‡ªåˆ†è‡ªèº«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                }
              }
            }
          } else if (mode === "sim") {
            if (target !== -1) {
              isDragging = true;
              draggedPointIndex = target;
            }
          }
        });

        canvas.addEventListener("mousemove", (e) => {
          if (mode === "sim" && isDragging) {
            const pos = getMousePos(e);
            world.setParticlePos(draggedPointIndex, pos.x, pos.y);
          }
        });

        canvas.addEventListener("mouseup", () => {
          isDragging = false;
          draggedPointIndex = -1;
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹
        canvas.addEventListener("contextmenu", (e) => e.preventDefault());

        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        function loop() {
          // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘ç‰©ç†æ¼”ç®—ã‚’é€²ã‚ã‚‹
          if (mode === "sim") {
            world.update();
          }

          // æç”»
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // 1. ãƒªãƒ³ã‚¯æç”»
          ctx.lineWidth = 4;
          ctx.strokeStyle = "cyan";
          ctx.beginPath();
          const cCount = world.getConstraintCount();
          for (let i = 0; i < cCount; i++) {
            const idx1 = world.getConstraintP1(i);
            const idx2 = world.getConstraintP2(i);
            ctx.moveTo(world.getParticleX(idx1), world.getParticleY(idx1));
            ctx.lineTo(world.getParticleX(idx2), world.getParticleY(idx2));
          }
          ctx.stroke();

          // ç·¨é›†ä¸­ã®è£œåŠ©ç·šï¼ˆé¸æŠä¸­ã®ç‚¹ã‹ã‚‰ãƒã‚¦ã‚¹ã¾ã§ç·šã‚’å¼•ãã¨ã‹ã£ã“ã„ã„ï¼‰
          // (çœç•¥ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€ã‚ã‚‹ã¨è¦ªåˆ‡ã§ã™)

          // 2. ç‚¹æç”»
          const pCount = world.getParticleCount();
          for (let i = 0; i < pCount; i++) {
            const x = world.getParticleX(i);
            const y = world.getParticleY(i);
            const isFixed = world.isParticleFixed(i);

            ctx.beginPath();
            ctx.arc(x, y, 10, 0, Math.PI * 2);

            // è‰²åˆ†ã‘
            if (i === selectedIndex) {
              ctx.fillStyle = "yellow"; // é¸æŠä¸­
            } else if (isFixed) {
              ctx.fillStyle = "red"; // å›ºå®šç‚¹
            } else {
              ctx.fillStyle = "white"; // æ™®é€šã®ç‚¹
            }
            ctx.fill();

            // é¸æŠä¸­ã¯æ ç·šã‚’ã¤ã‘ã‚‹
            if (i === selectedIndex) {
              ctx.strokeStyle = "white";
              ctx.lineWidth = 2;
              ctx.stroke();
            }
          }

          requestAnimationFrame(loop);
        }
        loop();
      };
    </script>
  </body>
</html>
