<!DOCTYPE html>
<html>
  <head>
    <title>PBD Linkage Sim</title>
    <style>
      body {
        margin: 0;
        background: #222;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      canvas {
        background: #333;
        box-shadow: 0 0 20px black;
      }
    </style>
  </head>
  <body>
    <canvas id="simCanvas" width="800" height="600"></canvas>

    <script src="index.js"></script>

    <script>
      // Wasmの準備ができたら呼ばれる
      Module.onRuntimeInitialized = function () {
        console.log("Wasm Loaded!");

        const canvas = document.getElementById("simCanvas");
        const ctx = canvas.getContext("2d");

        // C++の世界を生成
        const world = new Module.World();
        let isDragging = false;
        let draggedPointIndex = -1;

        // マウス座標をCanvas内の座標に変換する便利関数
        function getMousePos(canvas, evt) {
          const rect = canvas.getBoundingClientRect();
          return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top,
          };
        }

        // マウスを押した時
        canvas.addEventListener("mousedown", (e) => {
          const pos = getMousePos(canvas, e);

          // 全部の点をチェックして、マウスに近い点を探す
          // (点は2個しかないのでループでOK)
          let minDist = 20; // 半径20px以内なら掴めることにする
          let targetIndex = -1;

          for (let i = 0; i < 2; i++) {
            const px = world.getParticleX(i);
            const py = world.getParticleY(i);
            const dx = pos.x - px;
            const dy = pos.y - py;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < minDist) {
              minDist = dist;
              targetIndex = i;
            }
          }

          if (targetIndex !== -1) {
            isDragging = true;
            draggedPointIndex = targetIndex;
          }
        });

        // マウスを動かした時
        canvas.addEventListener("mousemove", (e) => {
          if (isDragging && draggedPointIndex !== -1) {
            const pos = getMousePos(canvas, e);
            // C++に「この点をここに移動させろ」と命令
            world.setParticlePos(draggedPointIndex, pos.x, pos.y);
          }
        });

        // マウスを離した時
        canvas.addEventListener("mouseup", () => {
          isDragging = false;
          draggedPointIndex = -1;
        });

        // マウスがキャンバス外に出た時も離したことにする
        canvas.addEventListener("mouseleave", () => {
          isDragging = false;
          draggedPointIndex = -1;
        });
        function loop() {
          // 1. 計算 (C++へ依頼)
          world.update();

          // 2. 描画 (JSのお仕事)
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // 座標を取得
          const x0 = world.getParticleX(0);
          const y0 = world.getParticleY(0);
          const x1 = world.getParticleX(1);
          const y1 = world.getParticleY(1);

          // 線を引く（棒）
          ctx.strokeStyle = "cyan";
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.moveTo(x0, y0);
          ctx.lineTo(x1, y1);
          ctx.stroke();

          // 点を描く
          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.arc(x0, y0, 5, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(x1, y1, 10, 0, Math.PI * 2);
          ctx.fill();

          requestAnimationFrame(loop);
        }

        loop();
      };
    </script>
  </body>
</html>
